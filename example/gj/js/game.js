"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Game=function(){function e(){_classCallCheck(this,e),this.userName="",this.scenes="home",this.step="inputUserName",this.shop="shop-A",this.shopSlide=null,this.shopInfo=[{examName:"告白檢定考",description:"好的告白為愛情漂亮開局\n測驗你的告白能力"},{examName:"包容檢定考",description:"讀懂另一半，才能走更遠\n測驗你的包容能力"},{examName:"求生檢定考",description:"愛情裡，活下去才是贏家\n測驗你的求生能力"},{examName:"練愛講習",description:"月老有話要對你說"},{examName:"撩心檢定考",description:"說再多話不如說好聽話\n測驗你的撩心能力"},{examName:"浪漫檢定考",description:"浪漫舉動，是感情催化劑\n測驗你的浪漫能力"},{examName:"搭訕檢定考",description:"搭訕不難，但成功很難\n測驗你的搭訕能力"}],this.scanStatus="not-yet",this.scaaned={"shop-A":!1,"shop-B":!1,"shop-C":!1,"shop-D":!1,"shop-E":!1,"shop-F":!1,"shop-G":!1},this.teachIndex=0,this.selectedExamOption=null,this.examHistory={"shop-A":null,"shop-B":null,"shop-C":null,"shop-D":null,"shop-E":null,"shop-F":null,"shop-G":null},this.certificate_bg=new Image,this.certificate_seal1=new Image,this.certificate_seal2=new Image,this.certificate_seal3=new Image,this.certificate_seal4=new Image,this.certificate_seal5=new Image,this.certificate_seal6=new Image,this.certificate_lv="愛情小白",this.certificate_desc1="愛情不會憑空出現，需要自己",this.certificate_desc2="爭取，立即付出行動吧",this.base64image=""}return _createClass(e,[{key:"toScenes",value:function(e){this.scenes=e;e=localStorage.getItem("userName");e&&(this.userName=e,this.step="map")}},{key:"toStep",value:function(e){this.step=e}},{key:"toMap",value:function(){this.toStep("map")}},{key:"toExam",value:function(){"shop-D"===this.shop?this.toStep("preparing"):this.toStep("exam")}},{key:"saveUserName",value:function(){if(!this.userName)return alert("請輸入使用者名稱"),!1;localStorage.setItem("userName",this.userName),this.toStep("map")}},{key:"selectShop",value:function(e){var t=this;this.shop=e.target.id,null===this.examHistory[this.shop]||"shop-D"===this.shop?(this.shopSlide=new Swiper(".shop-slide",{slidesPerView:1,loop:!0,allowTouchMove:!1,pagination:{el:".swiper-pagination"}}),e=["shop-A","shop-B","shop-C","shop-D","shop-E","shop-F","shop-G"].findIndex(function(e){return e==t.shop}),this.toStep("selectShop"),this.shopSlide.slideToLoop(e)):this.toStep("result")}},{key:"checkTestedAndProceed",value:function(){var e=null!==this.examHistory[this.shop];localStorage.getItem("hasClick")||localStorage.setItem("hasClick",!0),e&&"shop-D"!==this.shop?this.toStep("result"):(this.toStep("preparing"),"shop-D"===this.shop&&(this.examHistory["shop-D"]="pass",localStorage.setItem("examHistory",JSON.stringify(this.examHistory))))}},{key:"foundShop",value:function(e){this.shop=["shop-A","shop-B","shop-C","shop-D","shop-E","shop-F","shop-G"][e]}},{key:"toSlidePerv",value:function(){this.shopSlide.slidePrev();var e=this.shopSlide.realIndex;this.foundShop(e)}},{key:"toSlideNext",value:function(){this.shopSlide.slideNext();var e=this.shopSlide.realIndex;this.foundShop(e)}},{key:"initScan",value:function(){this.scanStatus="not-yet"}},{key:"requestCameraPermissions",value:function(i){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}).then(function(e){var t=e.getTracks()[0];index_view.cameraTrack=t,i.srcObject=e,i.play()}).catch(function(e){console.error("Error accessing the camera",e)}),!0):(console.error("getUserMedia not supported by this browser."),alert("getUserMedia not supported by this browser."),!1)}},{key:"toScan",value:function(){var e=this;this.toStep("scanImage"),this.scanStatus="init",index_view.$nextTick(function(){e.toAnimation()})}},{key:"toAnimation",value:function(){var e=this,t=this.shop.split("shop-")[1];this.scaaned[this.shop]=!0;var i=bodymovin.loadAnimation({container:document.getElementById("yue-lao-init"),path:"./static/".concat(t,"_Appear.json"),loop:!1});bodymovin.loadAnimation({container:document.getElementById("yue-lao-permanent"),path:"./static/".concat(t,"_Standby.json"),loop:!0});document.getElementById("scan-audio").play(),i.addEventListener("complete",function(){e.scanStatus="inited",setTimeout(function(){return"D"!==t&&void e.toStep("teach")},4500)})}},{key:"selectExamOption",value:function(t,e){this.selectedExamOption=t;var i=e.options.findIndex(function(e){return e===t});if(!(null===(e=e.audio)||void 0===e?void 0:e[i]))return!1;document.getElementById("voice-".concat(i)).play()}},{key:"submitAnswer",value:function(e){if(null===this.selectedExamOption)return alert("請選擇答案"),!1;var t;confirm("確定要提交嗎?")&&(delete(t=JSON.parse(JSON.stringify(this.examHistory)))["shop-D"],Object.values(t).filter(function(e){return null!==e}).length,e=e===this.selectedExamOption?"pass":"fail",this.examHistory[this.shop]=e,localStorage.setItem("examHistory",JSON.stringify(this.examHistory)),this.toStep("checkAnswer"))}},{key:"toResult",value:function(){this.toStep("result"),this.selectedExamOption=null}},{key:"prevTeach",value:function(){0<this.teachIndex&&this.teachIndex--}},{key:"nextTeach",value:function(){this.teachIndex<4&&this.teachIndex++}},{key:"playTeachAudio",value:function(e){document.getElementById("teachVoice").play()}},{key:"clickTeachBtn",value:function(){null!==this.examHistory[this.shop]?this.toStep("result"):this.toStep("exam")}},{key:"renderImages",value:function(){var a=this,e=[{key:"G",x:94,y:518},{key:"A",x:270,y:518},{key:"E",x:445,y:518},{key:"C",x:94,y:694},{key:"F",x:270,y:694},{key:"B",x:445,y:694}].map(function(e,t){var i=e.key,s=e.x,e=e.y,i=a.examHistory["shop-".concat(i)],e={url:"images/certificate-character-default.png",x:s,y:e,w:126,h:126};return null!==i&&(e.url="images/certificate-character-".concat(t+1,"-").concat(i,".png")),e}),t=JSON.parse(JSON.stringify(this.examHistory));delete t["shop-D"];t=Object.values(t).filter(function(e){return"pass"===e}).length;return this.certificate_lv=resultMapping.canvas[t].title,this.certificate_desc1=resultMapping.canvas[t].des1,this.certificate_desc2=resultMapping.canvas[t].des2,e.unshift({url:"images/certificate-bg.png",x:0,y:0,w:666,h:903}),e}},{key:"draw_canvas",value:function(){var t=this,i=document.getElementById("canvas"),n=i.getContext("2d");i.width=666,i.height=903;var e=this.renderImages().map(function(e){var s=e.url,a=e.x,n=e.y,o=e.w,r=e.h;return new Promise(function(e,t){var i=new Image;i.src=s,i.onload=function(){return e({img:i,x:a,y:n,w:o,h:r})}})});Promise.all(e).then(function(e){e.forEach(function(e){var t=e.img,i=e.x,s=e.y,a=e.w,e=e.h;n.drawImage(t,i,s,a,e)}),n.beginPath(),n.moveTo(119,236),n.font="900 43px Noto Sans TC",n.fillStyle="#1a81c1",n.textAlign="center",n.fillText(t.userName,239,286),n.font="700 36px Noto Sans TC",n.fillStyle="#3d3d3d",n.textAlign="left-aligned",n.fillText("aka",160,336),n.font="700 38px Noto Sans TC",n.fillStyle="#cc4242",n.fillText(t.certificate_lv,270,334),n.font="500 22px Noto Sans TC",n.fillStyle="#3d3d3d",n.textAlign="center",n.fillText(t.certificate_desc1,240,374),n.fillText(t.certificate_desc2,240,409),t.base64image=i.toDataURL()})}},{key:"toCertificate",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.toStep("certificate"),t&&index_view.sendReceiveCertificate(),index_view.showToCertificate=!1,index_view.$nextTick(function(){return e.draw_canvas()})}},{key:"menuToCertificate",value:function(){this.toScenes("game"),this.toCertificate()}},{key:"share",value:function(){var e="https://release.azureedge.net/gjunloveschool/";navigator.share?navigator.share({title:"練愛分校｜巨匠教育x霞海城隍廟",text:"通過月老檢定考，獲取你的戀愛認證! 完成檢定再領限量霞海加持戀愛平安符等好禮!",url:e}):(e=encodeURI("練愛分校｜巨匠教育x霞海城隍廟\r\n通過月老檢定考，獲取你的戀愛認證! 完成檢定再領限量霞海加持戀愛平安符等好禮!\r\n".concat(e)),e="http://line.naver.jp/R/msg/text/?".concat(e),window.open(e))}}]),e}();